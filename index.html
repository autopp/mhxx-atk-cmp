<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>MHXX Atack Comparator</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
  </head>
  <body>
    <h1>MHXX Atack Comparator</h1>
    <div id="app"></div>
    <script src="js/react.min.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script src="js/babel.min.js"></script>
    <script type="text/jsx">
      var createFormState = function () {
        return {
          weaponAtk: 300, weaponCrit: 0, sharpness: 'purple',
          possessedItem: 'both', permanentItem: 'none', temporaryItem: 'none', food: 'none',
          atkUp: 'none', critUp: 'none', leftArmSkill: 'none',
          weakness: false, superCrit: false,
          result: '-'
        };
      };

      var findFactor = function (ary, value) {
        return ary.find((x) => x.value === value).factor;
      };

      var calcExpectedAtk = function (cxt) {
        var baseAtk = cxt.weaponAtk +
          findFactor(possessedItems, cxt.possessedItem) +
          findFactor(permanentItems, cxt.permanentItem) +
          findFactor(temporaryItems, cxt.temporaryItem) +
          findFactor(foods, cxt.food) + findFactor(atkUps, cxt.atkUp) +
          findFactor(leftArmSkills, cxt.leftArmSkill).atk;
        var crit = cxt.weaponCrit + findFactor(critUps, cxt.critUp) +
          findFactor(leftArmSkills, cxt.leftArmSkill).crit + (cxt.weakness ? 50 : 0);
        crit = Math.min(Math.max(crit, -100), 100);
        let critFactor = crit >= 0 && cxt.superCrit ? 0.4 : 0.25
        let sharpness = findFactor(sharpnesses, cxt.sharpness);
        return (baseAtk) * (1 + crit * critFactor / 100) * sharpness;
      };

      var labelColClass="col-md-2";
      var inputColClass="col-md-3";
      var syncColClass="col-md-1";

      var sharpnesses = [
        { value: 'purple', factor: 1.39, text: '紫 (1.39)' },
        { value: 'white', factor: 1.32, text: '白 (1.32)' },
        { value: 'blue', factor: 1.2, text: '青 (1.2)' },
        { value: 'green', factor: 1.05, text: '緑 (1.05)' },
        { value: 'yellow', factor: 1.0, text: '黄 (1.0)' },
        { value: 'orange', factor: 0.75, text: '橙 (0.75)' },
        { value: 'red', factor: 0.5, text: '赤 (0.5)' }
      ];

      var possessedItems = [
        { value: 'both', factor: 15, text: '爪・護符 (+15)' },
        { value: 'claw', factor: 9, text: '爪のみ (+9)' },
        { value: 'amulet', factor: 6, text: '護符のみ (+6)' },
        { value: 'none', factor: 0, text: 'なし (+0)' }
      ];

      var permanentItems = [
        { value: 'great', factor: 7, text: '鬼人薬グレート (+7)' },
        { value: 'normal', factor: 5, text: '鬼人薬 (+5)' },
        { value: 'none', factor: 0, text: 'なし (+0)' }
      ];

      var temporaryItems = [
        { value: 'pill', factor: 25, text: '怪力の丸薬 (+25)' },
        { value: 'seed', factor: 10, text: '怪力の種 (+10)' },
        { value: 'none', factor: 0, text: 'なし (+0)' }
      ];

      var foods = [
        { value: 'large', factor: 7, text: '攻撃力【大】 (+7)' },
        { value: 'medium', factor: 5, text: '攻撃力【中】 (+5)' },
        { value: 'small', factor: 3, text: '攻撃力【小】 (+3)' },
        { value: 'none', factor: 0, text: 'なし (+0)' }
      ];

      var atkUps = [
        { value: 'large', factor: 20, text: '攻撃力UP【大】 (+20)' },
        { value: 'medium', factor: 15, text: '攻撃力UP【中】 (+15)' },
        { value: 'small', factor: 10, text: '攻撃力UP【小】 (+10)' },
        { value: 'none', factor: 0, text: 'なし (+0)' }
      ];

      var critUps = [
        { value: 'up3', factor: 30, text: '見切り+3 (+30)' },
        { value: 'up2', factor: 20, text: '見切り+2 (+20)' },
        { value: 'up1', factor: 10, text: '見切り+1 (+10)' },
        { value: 'none', factor: 0, text: 'なし (+0)' },
        { value: 'down1', factor: -5, text: '見切り-1 (-5)' },
        { value: 'down2', factor: -10, text: '見切り-2 (-10)' },
        { value: 'down3', factor: -15, text: '見切り-3 (-15)' }
      ];

      var leftArmSkills = [
        { value: 'challenger2', factor: { atk: 20, crit: 15 }, text: '挑戦者2 (攻撃+20, 会心+15)' },
        { value: 'challenger1', factor: { atk: 10, crit: 10 }, text: '挑戦者1 (攻撃+10, 会心+10)' },
        { value: 'fullCharge', factor: { atk: 20, crit: 0 }, text: 'フルチャージ (攻撃+20)' },
        { value: 'latentPower2', factor: { atk: 0, crit: 50 }, text: '力の解放2 (会心+50)' },
        { value: 'latentPower1', factor: { atk: 0, crit: 30 }, text: '力の解放1 (会心+30)' },
        { value: 'none', factor: { atk: 0, crit: 0 }, text: 'なし (+0)' }
      ];

      var App = React.createClass({
        getInitialState: function() {
          return {
            left: createFormState(), right: createFormState(),
            sync: {}
          };
        },
        setForm: function (pos, item, value) {
          if (this.state.sync[item]) {
            var left = this.state.left;
            var right = this.state.right;
            left[item] = right[item] = value;
            left.result = calcExpectedAtk(left);
            right.result = calcExpectedAtk(right);
            this.setState({ left: left, right: right });
          } else {
            var state = this.state[pos];
            state[item] = value;
            state.result = calcExpectedAtk(state);
            this.setState({ [pos]: state });
          }
        },
        setSync: function (item, value) {
          var state = this.state;
          var sync = state.sync;
          sync[item] = value;
          var updated = { sync: sync };
          if (value === true) {
            var right = state.right;
            right[item] = state.left[item];
            right.result = calcExpectedAtk(right);
            updated.right = right;
          }
          this.setState(updated);
        },
        render: function () {
          return (
            <div className="container">
              <NumberInputRow labelText="武器攻撃力" item="weaponAtk" state={this.state} min={0} max={1000} step={10} onChange={this.setForm} setSync={this.setSync} />
              <NumberInputRow labelText="武器会心率" item="weaponCrit" state={this.state} min={-100} max={100} step={5} onChange={this.setForm} setSync={this.setSync} />
              <div className="row">
                <div className={labelColClass}>
                  <p>斬れ味</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="sharpness" value={this.state.left.sharpness} items={sharpnesses} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="sharpness" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="sharpness" value={this.state.right.sharpness} items={sharpnesses} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>爪・護符</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="possessedItem" value={this.state.left.possessedItem} items={possessedItems} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="possessedItem" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="possessedItem" value={this.state.right.possessedItem} items={possessedItems} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>鬼人薬</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="permanentItem" value={this.state.left.permanentItem} items={permanentItems} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="permanentItem" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="permanentItem" value={this.state.right.permanentItem} items={permanentItems} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>種・丸薬</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="temporaryItem" value={this.state.left.temporaryItem} items={temporaryItems} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="temporaryItem" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="temporaryItem" value={this.state.right.temporaryItem} items={temporaryItems} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>食事</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="food" value={this.state.left.food} items={foods} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="food" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="food" value={this.state.right.food} items={foods} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>攻撃力UP</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="atkUp" value={this.state.left.atkUp} items={atkUps} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="atkUp" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="atkUp" value={this.state.right.atkUp} items={atkUps} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>達人</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="critUp" value={this.state.left.critUp} items={critUps} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="critUp" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="critUp" value={this.state.right.critUp} items={critUps} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>闘魂・無傷・本気</p>
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="left" item="leftArmSkill" value={this.state.left.leftArmSkill} items={leftArmSkills} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="leftArmSkill" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <RadioInput pos="right" item="leftArmSkill" value={this.state.right.leftArmSkill} items={leftArmSkills} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>弱点特効</p>
                </div>
                <div className={inputColClass}>
                  <CheckboxInput pos="left" item="weakness" value={this.state.left.weakness} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="weakness" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <CheckboxInput pos="right" item="weakness" value={this.state.right.weakness} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>超会心</p>
                </div>
                <div className={inputColClass}>
                  <CheckboxInput pos="left" item="superCrit" value={this.state.left.superCrit} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="superCrit" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <CheckboxInput pos="right" item="superCrit" value={this.state.right.superCrit} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>計算結果</p>
                </div>
                <div className={inputColClass}>
                  <Result result={this.state.left.result} />
                </div>
                <div className={syncColClass}></div>
                <div className={inputColClass}>
                  <Result result={this.state.right.result} />
                </div>
              </div>
            </div>
          );
        }
      });

      var SyncInputs = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.item, e.target.checked);
        },
        render: function (e) {
          return (
            <input type="checkbox" data-item={this.props.item} onChange={this._onChange} />
          );
        }
      });

      var NumberInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, parseInt(e.target.value, 10));
        },

        render: function () {
          return <input type="number" value={this.props.value} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this._onChange} />
        }
      });

      var NumberInputRow = React.createClass({
        render: function () {
          return (
            <div className="row">
              <div className={labelColClass}>
                <p>{this.props.labelText}</p>
              </div>
              <div className={inputColClass}>
                <NumberInput pos="left" item={this.props.item} value={this.props.state.left[this.props.item]} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this.props.onChange} />
              </div>
              <div className={syncColClass}>
                <SyncInputs item="weaponAtk" onChange={this.props.setSync} />
              </div>
              <div className={inputColClass}>
                <NumberInput pos="right" item={this.props.item} value={this.props.state.right[this.props.item]} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this.props.onChange} />
              </div>
            </div>
          );
        }
      });

      var RadioInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, e.target.value);
        },

        render: function () {
          var items = this.props.items.map((item) => {
            return <label><input type="radio" name={`${this.props.pos}.${this.props.item}`} value={item.value} checked={this.props.value === item.value} onChange={this._onChange}>{item.text}</input></label>;
          });

          return <div>{items}</div>;
        }
      });

      var CheckboxInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, e.target.checked);
        },

        render: function () {
          return <input type="checkbox" data-item={this.props.item} onChange={this._onChange} checked={this.props.value} />;
        }
      });

      var Result = React.createClass({
        render: function () {
          return (
            <div>
              <p>{this.props.result}</p>
            </div>
          );
        }
      });

      React.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>
