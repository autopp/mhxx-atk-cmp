<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>MHXX Atack Comparator</title>
    <script src="js/react.min.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script src="js/babel.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
  </head>
  <body>
    <h1>MHXX Atack Comparator</h1>
    <div id="app"></div>
    <script type="text/jsx">
      var createFormState = function () {
        return {
          weaponAtk: 0, weaponCrit: 0,
          result: 0.0
        };
      };

      var calcExpectedAtk = function (cxt) {
        return cxt.weaponAtk * (1 + cxt.weaponCrit * 0.25 / 100);
      };

      var otherSideOf = function(pos) {
        if (pos === 'left') {
          return 'right';
        } else if (pos === 'right') {
          return 'left';
        } else {
          console.error(`otherSideOf: unexpected argument ${pos}`);
        }
      }

      var labelColClass="col-md-2"
      var inputColClass="col-md-1"
      var syncColClass="col-md-1 col-md-offset-1"

      var App = React.createClass({
        getInitialState: function() {
          return {
            left: createFormState(), right: createFormState(),
            sync: {
              weaponAtk: false, weaponCrit: false
            }
          };
        },
        setForm: function (pos, item, value) {
          console.log(this.state.sync[item]);
          if (this.state.sync[item]) {
            var left = this.state.left;
            var right = this.state.right;
            left[item] = right[item] = value;
            left.result = calcExpectedAtk(left);
            right.result = calcExpectedAtk(right);
            this.setState({ left: left, right: right });
          } else {
            var state = this.state[pos];
            state[item] = value;
            state.result = calcExpectedAtk(state);
            this.setState({ [pos]: state });
          }
        },
        setSync: function (item, value) {
          var state = this.state;
          var sync = state.sync;
          sync[item] = value;
          var updated = { sync: sync };
          if (value === true) {
            var right = state.right;
            right[item] = state.left[item];
            right.result = calcExpectedAtk(right);
            updated.right = right;
          }
          this.setState(updated);
        },
        render: function () {
          return (
            <div className="container">
              <div className="row">
                <div className={labelColClass}>
                  <p>武器攻撃力</p>
                </div>
                <div className={inputColClass}>
                  <NumberInput pos="left" item="weaponAtk" value={this.state.left.weaponAtk} min={0} max={1000} step={10} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="weaponAtk" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <NumberInput pos="right" item="weaponAtk" value={this.state.right.weaponAtk} min={0} max={1000} step={10} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>武器会心率</p>
                </div>
                <div className={inputColClass}>
                  <NumberInput pos="left" item="weaponCrit" value={this.state.left.weaponCrit} min={-100} max={100} step={5} onChange={this.setForm} />
                </div>
                <div className={syncColClass}>
                  <SyncInputs item="weaponCrit" onChange={this.setSync} />
                </div>
                <div className={inputColClass}>
                  <NumberInput pos="right" item="weaponCrit" value={this.state.right.weaponCrit} min={-100} max={100} step={5} onChange={this.setForm} />
                </div>
              </div>
              <div className="row">
                <div className={labelColClass}>
                  <p>計算結果</p>
                </div>
                <div className={inputColClass}>
                  <Result result={this.state.left.result} />
                </div>
                <div className={syncColClass}></div>
                <div className={inputColClass}>
                  <Result result={this.state.right.result} />
                </div>
              </div>
            </div>
          );
        }
      });

      var SyncInputs = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.item, e.target.checked);
        },
        render: function (e) {
          return (
            <input type="checkbox" data-item={this.props.item} onChange={this._onChange} />
          );
        }
      });

      var NumberInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, parseInt(e.target.value, 10));
        },

        render: function () {
          return <input type="number" value={this.props.value} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this._onChange} />
        }
      });

      var Result = React.createClass({
        render: function () {
          return (
            <div>
              <p>{this.props.result}</p>
            </div>
          );
        }
      });

      React.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>
