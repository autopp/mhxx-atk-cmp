<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>MHXX Atack Comparator</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <div id="app"></div>
    <script src="js/react.min.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script src="js/babel.min.js"></script>
    <script type="text/jsx">
      var labelColClass="col-lg-2";
      var inputColClass="col-lg-4 center";
      var syncColClass="col-lg-2 center";

      var App = React.createClass({
        sharpnesses: [
          { value: 'purple', factor: { normal: 139, blunt: 100 }, text: '紫 (1.39)' },
          { value: 'white', factor: { normal: 132, blunt: 100 }, text: '白 (1.32)' },
          { value: 'blue', factor: { normal: 120, blunt: 100 }, text: '青 (1.2)' },
          { value: 'green', factor: { normal: 105, blunt: 110 }, text: '緑 (1.05)' },
          { value: 'yellow', factor: { normal: 100, blunt: 115 }, text: '黄 (1.0)' },
          { value: 'orange', factor: { normal: 75, blunt: 120 }, text: '橙 (0.75)' },
          { value: 'red', factor: { normal: 50, blunt: 120 }, text: '赤 (0.5)' }
        ],
        possessedItems: [
          { value: 'both', factor: 15, text: '爪・護符 (+15)' },
          { value: 'claw', factor: 9, text: '爪のみ (+9)' },
          { value: 'amulet', factor: 6, text: '護符のみ (+6)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        permanentItems: [
          { value: 'great', factor: 7, text: '鬼人薬グレート (+7)' },
          { value: 'normal', factor: 5, text: '鬼人薬 (+5)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        temporaryItems: [
          { value: 'pill', factor: 25, text: '怪力の丸薬 (+25)' },
          { value: 'seed', factor: 10, text: '怪力の種 (+10)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        foods: [
          { value: 'large', factor: 7, text: '攻撃力【大】 (+7)' },
          { value: 'medium', factor: 5, text: '攻撃力【中】 (+5)' },
          { value: 'small', factor: 3, text: '攻撃力【小】 (+3)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        atkUps: [
          { value: 'large', factor: 20, text: '攻撃力UP【大】 (+20)' },
          { value: 'medium', factor: 15, text: '攻撃力UP【中】 (+15)' },
          { value: 'small', factor: 10, text: '攻撃力UP【小】 (+10)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        critUps: [
          { value: 'up3', factor: 30, text: '見切り+3 (+30)' },
          { value: 'up2', factor: 20, text: '見切り+2 (+20)' },
          { value: 'up1', factor: 10, text: '見切り+1 (+10)' },
          { value: 'none', factor: 0, text: 'なし (+0)' },
          { value: 'down1', factor: -5, text: '見切り-1 (-5)' },
          { value: 'down2', factor: -10, text: '見切り-2 (-10)' },
          { value: 'down3', factor: -15, text: '見切り-3 (-15)' }
        ],
        leftArmSkills: [
          { value: 'challenger2', factor: { atk: 20, crit: 15 }, text: '挑戦者2 (攻撃+20, 会心+15)' },
          { value: 'challenger1', factor: { atk: 10, crit: 10 }, text: '挑戦者1 (攻撃+10, 会心+10)' },
          { value: 'fullCharge', factor: { atk: 20, crit: 0 }, text: 'フルチャージ (攻撃+20)' },
          { value: 'latentPower2', factor: { atk: 0, crit: 50 }, text: '力の解放2 (会心+50)' },
          { value: 'latentPower1', factor: { atk: 0, crit: 30 }, text: '力の解放1 (会心+30)' },
          { value: 'none', factor: { atk: 0, crit: 0 }, text: 'なし (+0)' }
        ],
        chainCrits: [
          { value: 'up30', factor: 30, text: '4 hits (+30)' },
          { value: 'up25', factor: 25, text: '1 hit (+25)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        climateAdaptions: [
          { value: 'climateAndDrink', factor: 20, text: '北風・クーラードリンク (+20)' },
          { value: 'climate', factor: 15, text: '北風/南風 (+15)' },
          { value: 'drink', factor: 5, text: 'クーラードリンク (+5)' },
          { value: 'none', factor: 0, text: 'なし (+0)' }
        ],
        fortifies: [
          { value: 'two', factor: 1.2, text: '2回 (1.2)' },
          { value: 'one', factor: 1.1, text: '1回 (1.1)' },
          { value: 'none', factor: 1.0, text: 'なし (1.0)' }
        ],
        wideExtracts: [
          { value: 'redWhite', factor: { atk: 5, crit: 10 }, text: '赤白 (攻撃+5, 会心+10)' },
          { value: 'red', factor: { atk: 5, crit: 0 }, text: '赤 (攻撃+5)' },
          { value: 'white', factor: { atk: 0, crit: 10 }, text: '白 (会心+10)' },
          { value: 'none', factor: { atk: 0, crit: 0 }, text: 'なし (+0)' }
        ],
        frenzies: [
          { value: 'antivirus', factor: 30, text: '無我の境地 (+30)' },
          { value: 'recovered', factor: 15, text: '克服 (+15)' },
          { value: 'none', factor: 1.0, text: 'なし (+0)' }
        ],
        getInitialState: function() {
          let leftState = {
            weaponAtk: 300, weaponCrit: 0, sharpness: 'purple',
            possessedItem: 'both', permanentItem: 'none', temporaryItem: 'none', food: 'none',
            atkUp: 'none', critUp: 'none', leftArmSkill: 'none',
            weakness: false, superCrit: false, reversedCrit: false, chainCrit: 'none',
            climateAdaption: 'none', blunt: false, resentment: false, resuscitate: false,
            fortify: 'none', adrenaline: false, wideExtract: 'none', frenzy: 'none',
            result: '-'
          };
          let rightState = Object.assign({}, leftState);
          let sync = {};
          Object.keys(leftState).forEach((key) => { sync[key] = false; });
          return { left: leftState, right: rightState, sync: sync };
        },
        setForm: function (pos, item, value) {
          if (this.state.sync[item]) {
            var left = this.state.left;
            var right = this.state.right;
            left[item] = right[item] = value;
            left.result = this.calcExpectedAtk(left);
            right.result = this.calcExpectedAtk(right);
            this.setState({ left: left, right: right });
          } else {
            var state = this.state[pos];
            state[item] = value;
            state.result = this.calcExpectedAtk(state);
            this.setState({ [pos]: state });
          }
        },
        setSync: function (item, value) {
          var state = this.state;
          var sync = state.sync;
          sync[item] = value;
          var updated = { sync: sync };
          if (value === true) {
            var right = state.right;
            right[item] = state.left[item];
            right.result = this.calcExpectedAtk(right);
            updated.right = right;
          }
          this.setState(updated);
        },
        syncAll: function () {
          let newSyncs = {};
          Object.keys(this.state.sync).forEach((key) => { console.log(key); newSyncs[key] = true; });
          console.log(newSyncs);
          this.setState({ sync: newSyncs });
        },
        calcExpectedAtk: function (cxt) {
          let baseAtk = this.calcAtack(cxt);
          let crit = this.calcCrit(cxt);
          let critFactor = this.calcCritFactor(crit, cxt);
          let sharpnessFactor = this.calcSharpnessFactor(cxt);
          return (baseAtk) * (100 + crit * critFactor) / 100 * sharpnessFactor / 10000;
        },
        calcAtack: function (cxt) {
          return (
            cxt.weaponAtk + this.findFactor('possessedItems', cxt.possessedItem) +
            this.findFactor('permanentItems', cxt.permanentItem) +
            this.findFactor('temporaryItems', cxt.temporaryItem) +
            this.findFactor('foods', cxt.food) + this.findFactor('atkUps', cxt.atkUp) +
            this.findFactor('leftArmSkills', cxt.leftArmSkill).atk +
            this.findFactor('climateAdaptions', cxt.climateAdaption) +
            (cxt.resentment ? 20 : 0) + (cxt.resuscitate ? 20 : 0) +
            this.findFactor('wideExtracts', cxt.wideExtract).atk
          ) * this.findFactor('fortifies', cxt.fortify) * (cxt.adrenaline ? 1.3 : 1);
        },
        calcCrit: function (cxt) {
          let crit = cxt.weaponCrit + this.findFactor('critUps', cxt.critUp) +
            this.findFactor('leftArmSkills', cxt.leftArmSkill).crit + (cxt.weakness ? 50 : 0) +
            this.findFactor('chainCrits', cxt.chainCrit) +
            this.findFactor('wideExtracts', cxt.wideExtract).crit +
            this.findFactor('frenzies', cxt.frenzy);
          return Math.min(Math.max(crit, -100), 100);
        },
        calcCritFactor: function (crit, cxt) {
          if (crit >= 0) {
            return cxt.superCrit ? 0.4 : 0.25;
          } else {
            return cxt.reversedCrit ? -1 / 8 : 0.25;
          }
        },
        calcSharpnessFactor: function (cxt) {
          let factor = this.findFactor('sharpnesses', cxt.sharpness);
          if (cxt.blunt) {
            return factor.normal * factor.blunt;
          } else {
            return factor.normal * 100;
          }
        },
        findFactor: function (item, value) {
          return this[item].find((x) => x.value === value).factor;
        },
        render: function () {
          return (
            <div className="container">
              <div className="row">
                <div className="col-lg-6">
                  <h1>MHXX Atack Comparator</h1>
                </div>
              </div>
              <SectionRow text="武器" />
              <NumberInputRow labelText="武器攻撃力" item="weaponAtk" state={this.state} min={0} max={1000} step={10} onChange={this.setForm} setSync={this.setSync} />
              <NumberInputRow labelText="武器会心率" item="weaponCrit" state={this.state} min={-100} max={100} step={5} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="斬れ味" item="sharpness" state={this.state} items={this.sharpnesses} onChange={this.setForm} setSync={this.setSync} />
              <SectionRow text="アイテム・食事" />
              <RadioInputRow labelText="護符・爪" item="possessedItem" state={this.state} items={this.possessedItems} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="鬼人薬" item="permanentItem" state={this.state} items={this.permanentItems} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="種・丸薬" item="temporaryItem" state={this.state} items={this.temporaryItems} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="食事" item="food" state={this.state} items={this.foods} onChange={this.setForm} setSync={this.setSync} />
              <SectionRow text="スキル" />
              <RadioInputRow labelText="攻撃力UP" item="atkUp" state={this.state} items={this.atkUps} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="見切り" item="critUp" state={this.state} items={this.critUps} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="挑戦者/フルチャージ/力の解放" item="leftArmSkill" state={this.state} items={this.leftArmSkills} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="弱点特効" item="weakness" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="超会心" item="superCrit" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="痛恨会心" item="reversedCrit" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="連撃の心得" item="chainCrit" state={this.state} items={this.chainCrits} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="北風の狩人/南風の狩人" item="climateAdaption" state={this.state} items={this.climateAdaptions} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="鈍器使い" item="blunt" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="逆恨み" item="resentment" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="死中に活" item="resuscitate" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="不屈" item="fortify" state={this.state} items={this.fortifies} onChange={this.setForm} setSync={this.setSync} />
              <CheckboxInputRow labelText="火事場力+2" item="adrenaline" state={this.state} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="エキス広域化" item="wideExtract" state={this.state} items={this.wideExtracts} onChange={this.setForm} setSync={this.setSync} />
              <RadioInputRow labelText="狂竜症" item="frenzy" state={this.state} items={this.frenzies} onChange={this.setForm} setSync={this.setSync} />
              <div className="row">
                <div className={labelColClass}>
                  <p>計算結果</p>
                </div>
                <div className={inputColClass}>
                  <Result result={this.state.left.result} />
                </div>
                <div className={syncColClass}></div>
                <div className={inputColClass}>
                  <Result result={this.state.right.result} />
                </div>
              </div>
              <div className="row">
                <div className="col-lg-2 col-lg-offset-6 center">
                  <button type="button" className="btn btn-success btn-xs" onClick={this.syncAll}>Sync all</button>
                </div>
              </div>
            </div>
          );
        }
      });

      var SectionRow = React.createClass({
        render: function () {
          return (
            <div className="row">
              <div className="col-lg-6"><h3>{this.props.text}</h3></div>
            </div>
          )
        }
      });

      var SyncInputs = React.createClass({
        _onClick: function (e) {
          this.props.onChange(this.props.item, !this.props.synced);
        },
        render: function (e) {
          let style = this.props.synced ? 'btn-info' : 'btn-default';
          let className = `btn ${style} btn-xs sync-button`
          let text = this.props.synced ? 'Synced' : 'Unsynced';
          return (
            <button type="button" className={className} onClick={this._onClick}>{text}</button>
          );
        }
      });

      var NumberInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, parseInt(e.target.value, 10));
        },

        render: function () {
          return <input type="number" value={this.props.value} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this._onChange} />
        }
      });

      var NumberInputRow = React.createClass({
        render: function () {
          return (
            <div className="row inputRow">
              <div className={labelColClass}>
                <p>{this.props.labelText}</p>
              </div>
              <div className={inputColClass}>
                <NumberInput pos="left" item={this.props.item} value={this.props.state.left[this.props.item]} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this.props.onChange} />
              </div>
              <div className={syncColClass}>
                <SyncInputs item={this.props.item} synced={this.props.state.sync[this.props.item]} onChange={this.props.setSync} />
              </div>
              <div className={inputColClass}>
                <NumberInput pos="right" item={this.props.item} value={this.props.state.right[this.props.item]} min={this.props.min} max={this.props.max} step={this.props.step} onChange={this.props.onChange} />
              </div>
            </div>
          );
        }
      });

      var RadioInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, e.target.value);
        },

        render: function () {
          var items = this.props.items.map((item) => {
            return <label className="radioButton"><input type="radio" name={`${this.props.pos}.${this.props.item}`} value={item.value} checked={this.props.value === item.value} onChange={this._onChange}>{item.text}</input></label>;
          });

          return <div>{items}</div>;
        }
      });

      var RadioInputRow = React.createClass({
        render: function () {
          return (
            <div className="row inputRow">
              <div className={labelColClass}>
                <p>{this.props.labelText}</p>
              </div>
              <div className={inputColClass}>
                <RadioInput pos="left" item={this.props.item} value={this.props.state.left[this.props.item]} items={this.props.items} onChange={this.props.onChange} />
              </div>
              <div className={syncColClass}>
                <SyncInputs item={this.props.item} synced={this.props.state.sync[this.props.item]} onChange={this.props.setSync} />
              </div>
              <div className={inputColClass}>
                <RadioInput pos="right" item={this.props.item} value={this.props.state.right[this.props.item]} items={this.props.items} onChange={this.props.onChange} />
              </div>
            </div>
          );
        }
      })

      var CheckboxInput = React.createClass({
        _onChange: function (e) {
          this.props.onChange(this.props.pos, this.props.item, e.target.checked);
        },

        render: function () {
          return <input type="checkbox" data-item={this.props.item} onChange={this._onChange} checked={this.props.value} />;
        }
      });

      var CheckboxInputRow = React.createClass({
        render: function () {
          return (
            <div className="row inputRow">
              <div className={labelColClass}>
                <p>{this.props.labelText}</p>
              </div>
              <div className={inputColClass}>
                <CheckboxInput pos="left" item={this.props.item} value={this.props.state.left[this.props.item]} onChange={this.props.onChange} />
              </div>
              <div className={syncColClass}>
                <SyncInputs item={this.props.item} synced={this.props.state.sync[this.props.item]} onChange={this.props.setSync} />
              </div>
              <div className={inputColClass}>
                <CheckboxInput pos="right" item={this.props.item} value={this.props.state.right[this.props.item]} onChange={this.props.onChange} />
              </div>
            </div>
          );
        }
      })

      var Result = React.createClass({
        render: function () {
          return (
            <div>
              <p>{this.props.result}</p>
            </div>
          );
        }
      });

      React.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>
